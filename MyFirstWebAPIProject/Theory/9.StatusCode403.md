-- What is 403 HTTP Status Code? --
- Mã trạng thái HTTP 403 Forbidden có nghĩa là “Bị từ chối truy cập”. Điều này cho thấy máy chủ đã hiểu yêu cầu từ client, nhưng từ chối thực hiện yêu cầu đó vì client không có quyền truy cập tài nguyên.
-  Nói cách khác, máy chủ phản hồi: “Tôi hiểu yêu cầu của bạn, nhưng tôi sẽ không thực hiện nó vì bạn không có quyền truy cập vào nội dung này.”

- Một số nguyên nhân phổ biến gây ra lỗi 403 bao gồm:
  1. Thiếu quyền truy cập (Insufficient Permissions):
    - Người dùng hoặc client không có đủ quyền (chẳng hạn như role không phù hợp) để truy cập vào tài nguyên. 
    - Có thể liên quan đến cơ chế kiểm soát truy cập theo vai trò (Role-Based Access Control - RBAC) hoặc các chính sách bảo mật nội bộ.
  2. Chặn IP (IP Blocking):
    - Máy chủ được cấu hình để từ chối các yêu cầu đến từ một số địa chỉ IP nhất định. Nếu địa chỉ IP của client nằm trong danh sách bị chặn, nó sẽ nhận được phản hồi 403.
  3. Giới hạn tài nguyên (Resource Restrictions):
    - Một số tài nguyên như thư mục hoặc file trên server được cấu hình để không cho phép truy cập công khai hoặc chỉ cho phép truy cập bởi một nhóm người dùng cụ thể.
  4. Bảo vệ CSRF (CSRF Protection):
    - Nếu máy chủ sử dụng cơ chế chống tấn công giả mạo yêu cầu liên trang (Cross-Site Request Forgery - CSRF), mà client không gửi kèm token CSRF hợp lệ, máy chủ có thể trả về lỗi 403.
- Cách xử lý lỗi 403 Forbidden: 
  1. Kiểm tra quyền truy cập:
    - Đảm bảo rằng người dùng hoặc token truy cập có đủ quyền (scope/role) để truy cập vào tài nguyên được yêu cầu.
  2. Xác minh thông tin xác thực:
    - Đảm bảo rằng client đã gửi đầy đủ thông tin xác thực (access token, session cookie, v.v…) và rằng các thông tin này còn hiệu lực.
  3. Kiểm tra cấu hình máy chủ:
    - Rà soát các cấu hình như web.config, nginx.conf, .htaccess, hoặc các thiết lập security trong code để phát hiện các rule đang giới hạn quyền truy cập.
  4. Xem lại giới hạn IP:
    -  Kiểm tra xem có rule nào đang giới hạn theo IP hoặc dải mạng đang sử dụng không.
  5. Xóa cache và cookie (trình duyệt):
    - Trong một số trường hợp, cache hoặc cookie cũ của trình duyệt có thể dẫn đến lỗi xác thực CSRF hoặc quyền truy cập bị sai lệch.

-- When Should We Return 403 HTTP Status Code in ASP.NET Core Web API? --
- Trong ASP.NET Core Web API, việc trả về mã trạng thái HTTP 403 (Forbidden) là phù hợp trong các trường hợp cụ thể liên quan đến bảo mật và phân quyền. Dưới đây là một số tình huống điển hình khi việc trả về mã 403 được xem là hợp lý:
  1. Thiếu quyền truy cập (Insufficient Permissions): 
    - Nếu người dùng đã được xác thực (authenticated) nhưng không có đủ quyền để truy cập một tài nguyên hoặc thực hiện một hành động nào đó, thì nên trả về mã 403
    - Ví dụ: người dùng thường (user thông thường) cố truy cập vào API chỉ dành cho admin, hoặc người dùng thiếu vai trò (role) hoặc claim cần thiết để truy cập tài nguyên bị giới hạn.
  2. Kiểm soát truy cập dựa trên vai trò (Role-Based Access Control - RBAC): 
    - Sử dụng RBAC, người dùng có thể đã xác thực nhưng vẫn không có vai trò phù hợp để truy cập vào tài nguyên cụ thể. 
    - Ví dụ: các quy tắc truy cập được tùy chỉnh vượt ra ngoài kiểm tra role đơn giản, chẳng hạn như giới hạn theo trạng thái tài khoản, cấp độ truy cập hoặc điều kiện kinh doanh.
  3. Chặn truy cập từ địa chỉ IP (Forbidden IP Addresses):
    -  Nếu máy chủ được cấu hình để từ chối truy cập từ một số địa chỉ IP hoặc dải IP nhất định, và một request đến từ IP bị cấm, thì server nên trả về mã 403.
  4. Từ chối liệt kê thư mục (Directory Listings Denied): 
    - Khi client cố gắng truy cập vào một thư mục trên server mà không được phép liệt kê nội dung (directory listing bị tắt), server sẽ phản hồi bằng mã 403.
  5. Thiếu token CSRF (Cross-Site Request Forgery): 
    - Nếu request thiếu token CSRF cần thiết, server nên trả về mã 403 để chỉ ra rằng request không hợp lệ hoặc không được phép.

- So sánh với mã trạng thái 401 Unauthorized:
  - 401 Unauthorized: Chỉ ra rằng request cần được xác thực (authentication required), nhưng client chưa cung cấp hoặc cung cấp sai thông tin xác thực.
  - 403 Forbidden: Chỉ ra rằng server đã hiểu request, client đã xác thực thành công, nhưng không được phép truy cập tài nguyên do thiếu quyền hạn.
