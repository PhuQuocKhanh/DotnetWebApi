-- Mã trạng thái HTTP 400: Bad Request (Yêu cầu không hợp lệ) --
- Mã trạng thái HTTP 400, hay còn gọi là “Bad Request”, cho biết rằng yêu cầu (request) được gửi từ client đến server không hợp lệ hoặc bị lỗi, khiến server không thể xử lý được yêu cầu đó. Lỗi này có thể xảy ra vì nhiều lý do, bao gồm:
- URL không hợp lệ: URL có thể bị sai cú pháp, chứa ký tự không hợp lệ hoặc không đúng định dạng.
- Tham số truy vấn (query parameters) không hợp lệ: Các tham số trong query string có thể bị thiếu, sai định dạng hoặc không được mã hóa đúng cách.
- Header không hợp lệ: Các header trong request có thể bị thiếu, sai định dạng hoặc không hợp lệ.
- Payload quá lớn: Phần thân của request (payload) có thể vượt quá giới hạn kích thước mà server cho phép.
- Cookie lỗi: Có thể có vấn đề với cookie được gửi kèm trong request như bị hỏng hoặc không hợp lệ.
- Payload không đúng định dạng: Nội dung gửi trong body của request không đúng định dạng mà server yêu cầu (ví dụ: JSON không hợp lệ).
- Content-Type không đúng: Header Content-Type không phù hợp với định dạng của payload, hoặc là loại không được server hỗ trợ.

- Cách xử lý lỗi 400 Bad Request:
- Khi phát triển các ứng dụng web hoặc API, bạn cần xử lý và khắc phục lỗi 400 một cách chính xác. Dưới đây là một số bước để kiểm tra và sửa lỗi:
  1. Kiểm tra URL: Đảm bảo URL được viết đúng cú pháp, không chứa ký tự đặc biệt không hợp lệ.
  2. Xác thực query string: Kiểm tra và đảm bảo các tham số trên URL được mã hóa đúng và có giá trị hợp lệ.
  3. Rà soát header: Đảm bảo tất cả các header cần thiết đã được thiết lập đúng và hợp lệ. 
  4. Kiểm tra payload: Xác nhận rằng payload không quá lớn, đúng định dạng (ví dụ JSON, XML,...) và đầy đủ dữ liệu bắt buộc.
  5. Xóa cookie: Nếu nghi ngờ cookie gây lỗi, thử xóa cookie khỏi trình duyệt hoặc client.
  6. Kiểm tra Content-Type: Đảm bảo Content-Type phản ánh đúng định dạng của dữ liệu trong request body, ví dụ application/json nếu gửi JSON.

- Lưu ý: Khi server trả về mã lỗi 400, trong phần response body thường sẽ chứa thông tin chi tiết hơn về lý do lỗi, giúp client hiểu và điều chỉnh lại request cho đúng. Mã lỗi 400 mang ý nghĩa là lỗi thuộc về phía client, không phải lỗi hệ thống server.

-- Giải thích chi tiết nội dung phản hồi lỗi 400: -- 
- type: Một đường dẫn URI trỏ đến tài liệu mô tả lỗi cụ thể. Trong ví dụ này, URI trỏ đến Section 15.5.1 của RFC 9110, giải thích cách sử dụng mã trạng thái HTTP và cấu trúc thông báo lỗi chuẩn trong API. (Bạn có thể copy đường link này và mở trong trình duyệt để đọc thêm).
- title: Mô tả ngắn gọn, dễ hiểu về bản chất lỗi. Ở đây là:
  👉 “One or more validation errors occurred.”
  → Có nghĩa là có một hoặc nhiều lỗi xác thực trong dữ liệu đầu vào.
- status: Mã trạng thái HTTP tương ứng, ở đây là 400, tương ứng với lỗi Bad Request — tức là server không thể xử lý được yêu cầu do dữ liệu từ phía client không hợp lệ.
- errors: Đây là đối tượng chứa thông tin các trường dữ liệu không hợp lệ cùng với thông điệp lỗi cụ thể cho từng trường. Ví dụ:

    City: "The City field is required." → Trường City là bắt buộc nhưng không được cung cấp.

    Name: "The Name field is required."

    Gender: "The Gender field is required."

- traceId: Mã định danh duy nhất cho request này.
→ traceId rất hữu ích cho việc theo dõi (trace) và debug. Nó giúp lập trình viên liên kết lỗi này với log nội bộ trên server. ASP.NET Core sẽ tự động sinh traceId nếu hệ thống logging và diagnostics được cấu hình đúng cách.

-- Cách phản hồi lỗi được sinh ra --
- Phản hồi lỗi này được ASP.NET Core tự động sinh ra khi quá trình xác thực model (model validation) không thành công.
- Khi một phương thức trong controller được đánh dấu với thuộc tính [ApiController], framework sẽ tự động thực hiện kiểm tra tính hợp lệ của dữ liệu đầu vào (model) trước khi phương thức được thực thi.
- Nếu việc kiểm tra không thành công, framework sẽ trả về một đối tượng ValidationProblemDetails với cấu trúc chuẩn có sẵn như đã mô tả. 
- Toàn bộ quá trình này được thực hiện tự động bởi framework, trước khi phương thức controller được chạy, vì vậy không cần thiết phải kiểm tra ModelState.IsValid trong phương thức nữa.

-- ProblemDetails for API Errors in ASP.NET Core --
- Lớp ProblemDetails được thiết kế để đóng gói thông tin lỗi theo định dạng có cấu trúc, giúp client (bên tiêu thụ API) dễ dàng hiểu được lỗi xảy ra là gì. Khi bạn xem định nghĩa của lớp ProblemDetails, bạn sẽ thấy chữ ký như sau:

-- Ý nghĩa các thuộc tính trong ProblemDetails -- 
1. Type
  - Mô tả: URI đại diện cho loại lỗi (problem type).
  - Ý nghĩa: Tham chiếu đến một trang tài liệu mô tả chi tiết về loại lỗi cụ thể, giúp client hiểu rõ hơn về lỗi. Đây là trường tùy chọn.
  - Ví dụ: https://tools.ietf.org/html/rfc7231#section-6.5.1 (mô tả lỗi HTTP 400 Bad Request).
2. Title
  - Mô tả: Tiêu đề ngắn gọn, dễ đọc mô tả về loại lỗi.
  - Ý nghĩa: Cung cấp mô tả ngắn, dạng văn bản thuần (plain text), dễ hiểu đối với người dùng cuối. Dùng để nhanh chóng truyền tải lỗi là gì.
  - Ví dụ: "Invalid Request Parameters", "Authentication Failed".
3. Status: 
  - Mô tả: Mã trạng thái HTTP ứng với lỗi.
  - Ý nghĩa: Đây là mã trạng thái HTTP mà server trả về tương ứng với lỗi xảy ra. Giúp client xác định rõ lỗi theo chuẩn HTTP.
    - Ví dụ:
    - 400 – Bad Request
    - 404 – Not Found
    - 500 – Internal Server Error
4. Detail
- Mô tả: Mô tả chi tiết lỗi cụ thể trong lần xảy ra này.
- Ý nghĩa: Cung cấp thông tin chi tiết hơn so với Title, giúp lập trình viên dễ debug hoặc cung cấp thông báo cụ thể hơn cho người dùng.
- Ví dụ: "The field 'username' is required but was not provided."
5. Instance
- Mô tả: URI tham chiếu đến phiên bản lỗi cụ thể.
- Ý nghĩa: Dùng để theo dõi hoặc định danh từng trường hợp lỗi cụ thể. Rất hữu ích cho việc log lỗi hoặc hỗ trợ kỹ thuật.
- Ví dụ: https://example.com/logs/12345 (URI tới chi tiết log lỗi).
6. Extensions
- Mô tả: Thuộc tính mở rộng dưới dạng dictionary (từ điển).
- Ý nghĩa: Cho phép thêm các thông tin tùy biến bên ngoài các trường mặc định. Rất phù hợp để truyền các metadata hoặc hướng dẫn bổ sung.
- Ví dụ:
  - { "retryAfter": 30 } (client nên đợi 30 giây trước khi gửi lại request).

-- When to Use 400 HTTP Status Code in ASP.NET Core Web API --
1. Lỗi xác thực (Validation Failures)
- Khi dữ liệu do client gửi lên không vượt qua được các bước xác thực — chẳng hạn như thiếu các trường bắt buộc, sai kiểu dữ liệu, hoặc không thỏa mãn các ràng buộc đã định nghĩa — thì API nên trả về mã lỗi 400. Điều này giúp client hiểu rằng họ cần hiệu chỉnh dữ liệu đầu vào để đúng với định dạng mà API yêu cầu.
2. Thiếu hoặc sai định dạng tham số (Missing or Malformed Parameters)
- Khi request không chứa đủ các tham số bắt buộc (ví dụ: query string, route parameter) hoặc định dạng sai (chẳng hạn gửi chuỗi trong khi hệ thống yêu cầu số), thì nên trả về mã lỗi 400. Điều này cũng áp dụng cho các phần khác của request như header nếu chúng không đúng chuẩn định dạng mong muốn.
3. Payload không hợp lệ (Invalid Request Payload)
- Khi phần thân (body) của request bị sai cú pháp — ví dụ: JSON hoặc XML bị lỗi cấu trúc — thì server không thể phân tích được nội dung, và lúc này mã lỗi 400 là lựa chọn phù hợp. Thông báo này cho biết phía client cần sửa lại payload trước khi gửi lại.
4. Vi phạm logic nghiệp vụ (Business Logic Violations)
- Ngay cả khi dữ liệu hợp lệ về mặt kỹ thuật và định dạng, nhưng nếu vi phạm quy tắc nghiệp vụ (chẳng hạn như tạo bản ghi trùng lặp trong khi hệ thống yêu cầu duy nhất), thì API vẫn có thể trả về mã 400. Điều này giúp client biết rằng thao tác không thể thực hiện do vi phạm các quy tắc xử lý nghiệp vụ được hệ thống định nghĩa.
