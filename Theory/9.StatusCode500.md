-- What is a 500 HTTP Status Code? --
- Mã trạng thái HTTP 500, còn được gọi là "Lỗi máy chủ nội bộ" (Internal Server Error), là một thông báo lỗi chung cho biết máy chủ đã gặp phải một tình huống không lường trước được khiến nó không thể xử lý được yêu cầu.
- Đây là lỗi thuộc về phía máy chủ (server-side), tức là vấn đề không nằm ở phía client hay yêu cầu của người dùng, mà do máy chủ gặp sự cố trong quá trình xử lý.

-- Các nguyên nhân phổ biến gây ra lỗi HTTP 500 trong ASP.NET Core Web API -- 
- Lỗi 500 Internal Server Error trong ASP.NET Core Web API thường xuất phát từ các sự cố không mong đợi ở phía máy chủ, khiến API không thể hoàn tất yêu cầu. 
- Dưới đây là các nguyên nhân phổ biến:
  1. Ngoại lệ không được xử lý (Unhandled Exceptions):
  - Bất kỳ ngoại lệ (exception) nào không được bắt và xử lý đều có thể dẫn đến lỗi 500. Các lỗi này thường bao gồm:
    - Lỗi tham chiếu null (NullReferenceException)
    - Chia cho 0 (DivideByZeroException)
    - Không khớp kiểu dữ liệu
    - Lỗi từ thư viện bên thứ ba
  2. Lỗi cấu hình (Configuration Issues):
  - Các lỗi trong file cấu hình hoặc thiết lập môi trường, chẳng hạn:
    - Sai cấu hình trong appsettings.json
    - Thiếu đăng ký dịch vụ trong Dependency Injection
    - Đường dẫn log không hợp lệ
    - Thiết lập sai môi trường chạy (Environment)
  3. Lỗi kết nối cơ sở dữ liệu (Database Errors):
  - Các lỗi khi kết nối hoặc thao tác với cơ sở dữ liệu, ví dụ:
    - Chuỗi kết nối (Connection String) sai
    - Máy chủ cơ sở dữ liệu không hoạt động
    - Truy vấn SQL lỗi hoặc timeout
    - Lỗi mapping dữ liệu
  4. Lỗi trong middleware (Middleware Issues):
  - Lỗi xảy ra trong pipeline middleware mà không được xử lý đúng cách, bao gồm:
    - Lỗi từ middleware custom
    - Cấu hình sai middleware mặc định của ASP.NET Core
  5. Lỗi từ dịch vụ bên ngoài (Third-Party Services):
  - Khi API hoặc dịch vụ bên thứ ba bị lỗi hoặc không phản hồi, có thể gây lỗi 500 nếu ứng dụng không xử lý ngoại lệ đó.
  6. Cạn kiệt tài nguyên hệ thống (Resource Exhaustion):
  - Khi máy chủ hết tài nguyên như RAM hoặc dung lượng ổ đĩa, hệ thống không thể tiếp tục xử lý yêu cầu và sinh ra lỗi 500.

-- How to Troubleshoot 500 Internal Server Error in ASP.NET Core Web API? --
1. Kiểm tra log hệ thống (Application Logs):
  - Bước đầu tiên để xử lý lỗi 500 là xem lại log của ứng dụng. ASP.NET Core cung cấp hệ thống logging mạnh mẽ, có thể cấu hình để ghi log ra console, file hoặc các dịch vụ giám sát bên ngoài
  - (ví dụ: Serilog, Seq, Application Insights...). Log sẽ giúp bạn xác định được chính xác vị trí và nguyên nhân gây ra lỗi.
2. Debug ở môi trường cục bộ (Local Development):
  - Chạy ứng dụng trong môi trường phát triển (Development) với thông báo lỗi chi tiết được bật. 
  - Đảm bảo biến môi trường được đặt là "ASPNETCORE_ENVIRONMENT=Development" và sử dụng middleware UseDeveloperExceptionPage() để hiển thị thông tin lỗi chi tiết trên trình duyệt khi xảy ra exception.
3. Sử dụng middleware xử lý ngoại lệ (Exception Handling Middleware):
  - Triển khai cơ chế xử lý ngoại lệ toàn cục bằng middleware UseExceptionHandler() trong pipeline của ứng dụng. 
  - Middleware này sẽ giúp bắt các exception chưa được xử lý, ghi log và trả về response lỗi một cách có kiểm soát (custom error response).
4. Rà soát cấu hình phụ thuộc (Dependency Configuration):
  - Kiểm tra lại các dịch vụ được đăng ký trong container DI (Dependency Injection) tại tệp Program.cs hoặc Startup.cs. 
  - Những dịch vụ bị thiếu hoặc cấu hình sai có thể gây lỗi tại runtime, mặc dù ứng dụng vẫn khởi động bình thường.
5. Rà soát mã nguồn và xử lý exception (Exception Sources):
  - Kiểm tra lại controller, service và các lớp liên quan để phát hiện các đoạn mã có thể phát sinh exception mà chưa được xử lý. 
  - Nên bao bọc các logic dễ lỗi bằng khối try-catch và ghi log exception để phục vụ việc theo dõi và phân tích sau này.
6. Kiểm tra các dịch vụ bên ngoài (External Dependencies):
  - Nếu ứng dụng có tích hợp với API, database hoặc dịch vụ bên thứ ba, hãy đảm bảo rằng các hệ thống đó đang hoạt động bình thường. 
  - Cần xử lý timeout, lỗi kết nối và các tình huống lỗi tiềm tàng từ các nguồn này bằng cách thêm logic kiểm tra và retry nếu cần.