<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      internalLogLevel="Warn"
      internalLogFile="internal-nlog.txt"
      throwConfigExceptions="true">

  <!-- Định nghĩa các target ghi log -->
  <targets>
    <!-- Ghi log bất đồng bộ (Async) vào SQL Server -->
    <target xsi:type="AsyncWrapper" name="asyncFileWrapper">
      <target xsi:type="Database" name="database"
        connectionString="Server=localhost;Database=NLogToDatabase;user=sa;password=Phuquockhanh!;TrustServerCertificate=True;"
        commandText="INSERT INTO LogEntries (Date, Level, Message, Logger, Exception, UniqueId, ServerIP, ApplicationName) VALUES (@date, @level, @message, @logger, @exception, @uniqueId, @serverIP, @appName)">
        
        <!-- Mapping tham số -->
        <parameter name="@date" layout="${date}" />
        <parameter name="@level" layout="${level:uppercase=true}" />
        <parameter name="@logger" layout="${logger}" />
        <parameter name="@message" layout="${message}" />
        <parameter name="@exception" layout="${exception:tostring}" />
        <parameter name="@uniqueId" layout="${event-properties:item=UniqueId}" />
        <!-- Hardcode Server IP -->
        <parameter name="@serverIP" layout="192.168.1.100" />
        <!-- Hardcode Application Name -->
        <parameter name="@appName" layout="MyWebAPI" />
      </target>
    </target>

    <!-- Ghi log ra console -->
    <target xsi:type="Console" name="console"
      layout="${longdate}|${level:uppercase=true}|${logger}|${message} ${exception:format=ToString}" />

    <!-- Target Null: loại bỏ log (dùng để filter namespace không cần thiết) -->
    <target xsi:type="Null" name="blackhole" />
  </targets>

  <!-- Quy tắc ghi log -->
  <rules>
    <!-- Loại bỏ log từ namespace Microsoft.* -->
    <logger name="Microsoft.*" minlevel="Trace" writeTo="blackhole" final="true" />
    <!-- Loại bỏ log từ namespace System.* -->
    <logger name="System.*" minlevel="Trace" writeTo="blackhole" final="true" />
    <!-- Ghi log mức Information trở lên vào database -->
    <logger name="*" minlevel="Information" writeTo="database" />
    <!-- Ghi log mức Debug trở lên ra console -->
    <logger name="*" minlevel="Debug" writeTo="console" />
  </rules>
</nlog>
